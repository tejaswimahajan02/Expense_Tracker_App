{% extends 'base.html' %}
{% load static %}

{% block title %}Expense Forecast{% endblock %}

{% block content %}

<!-- Page Header -->
<div class="page-header">
    <div>
        <h1 class="page-title">Expense Forecast</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item active" aria-current="page">
                    Forecast
                </li>
            </ol>
        </nav>
    </div>
    <a href="{% url 'add-expenses'%}" class="btn-primary-modern">
        <i class="fas fa-plus"></i> Add Expense
    </a>
</div>

<!-- Forecast Summary Cards -->
<div class="summary-cards fade-in">
    <div class="summary-card">
        <div class="summary-icon primary">
            <i class="fas fa-crystal-ball"></i>
        </div>
        <div class="summary-content">
            <div class="summary-label">Next Month Forecast</div>
            <div class="summary-value">{{currency}} {{next_month_forecast|floatformat:2|default:"0.00"}}</div>
            <div class="summary-trend">Predicted spending</div>
        </div>
    </div>
    <div class="summary-card">
        <div class="summary-icon accent">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="summary-content">
            <div class="summary-label">Trend</div>
            <div class="summary-value">+12%</div>
            <div class="summary-trend">vs last month</div>
        </div>
    </div>
    <div class="summary-card">
        <div class="summary-icon success">
            <i class="fas fa-target"></i>
        </div>
        <div class="summary-content">
            <div class="summary-label">Accuracy</div>
            <div class="summary-value">87%</div>
            <div class="summary-trend">Model confidence</div>
        </div>
    </div>
</div>

<!-- Forecast Charts -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin: 0 32px 24px;">
    <!-- Main Forecast Chart -->
    <div class="modern-card fade-in">
        <div class="card-header-modern">
            <h3 class="card-title-modern">
                <i class="fas fa-chart-area"></i> 6-Month Forecast
            </h3>
            <div style="display: flex; gap: 8px;">
                <button class="btn-secondary-modern" style="padding: 6px 12px; font-size: 12px;" onclick="updateForecast('3m')">3M</button>
                <button class="btn-primary-modern" style="padding: 6px 12px; font-size: 12px;" onclick="updateForecast('6m')">6M</button>
                <button class="btn-secondary-modern" style="padding: 6px 12px; font-size: 12px;" onclick="updateForecast('1y')">1Y</button>
            </div>
        </div>
        <div style="position: relative; height: 400px;">
            <canvas id="forecastChart" width="800" height="400"></canvas>
        </div>
    </div>

    <!-- Category Forecast -->
    <div class="modern-card fade-in">
        <div class="card-header-modern">
            <h3 class="card-title-modern">
                <i class="fas fa-pie-chart"></i> Category Forecast
            </h3>
        </div>
        <div style="position: relative; height: 400px;">
            <canvas id="categoryForecastChart" width="300" height="400"></canvas>
        </div>
    </div>
</div>

<!-- Forecast Details -->
<div class="modern-card fade-in" style="margin: 0 32px;">
    <div class="card-header-modern">
        <h3 class="card-title-modern">
            <i class="fas fa-list-alt"></i> Detailed Forecast
        </h3>
        <button class="btn-secondary-modern" onclick="refreshForecast()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
    
    {% if forecast_data %}
    <table class="modern-table">
        <thead>
            <tr>
                <th>Month</th>
                <th>Predicted Amount</th>
                <th>Confidence</th>
                <th>Top Categories</th>
                <th>Trend</th>
            </tr>
        </thead>
        <tbody>
            {% for month_data in forecast_data %}
            <tr>
                <td><strong>{{month_data.month}}</strong></td>
                <td>{{currency}} {{month_data.amount|floatformat:2}}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 60px; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden;">
                            <div style="width: {{month_data.confidence}}%; height: 100%; background: var(--success-color);"></div>
                        </div>
                        {{month_data.confidence}}%
                    </div>
                </td>
                <td>
                    <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                        {% for category in month_data.top_categories %}
                        <span class="category-tag {{category|lower}}" style="font-size: 11px; padding: 2px 8px;">
                            {{category}}
                        </span>
                        {% endfor %}
                    </div>
                </td>
                <td>
                    {% if month_data.trend > 0 %}
                    <span style="color: #dc3545;">
                        <i class="fas fa-arrow-up"></i> +{{month_data.trend}}%
                    </span>
                    {% elif month_data.trend < 0 %}
                    <span style="color: var(--success-color);">
                        <i class="fas fa-arrow-down"></i> {{month_data.trend}}%
                    </span>
                    {% else %}
                    <span style="color: var(--text-gray);">
                        <i class="fas fa-minus"></i> 0%
                    </span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 60px; color: var(--text-gray);">
        <i class="fas fa-crystal-ball" style="font-size: 64px; margin-bottom: 24px; display: block;"></i>
        <h3 style="color: var(--text-dark); margin-bottom: 12px;">No forecast available</h3>
        <p style="margin-bottom: 24px;">Add more expense data to generate accurate forecasts</p>
        <a href="{% url 'add-expenses'%}" class="btn-primary-modern">
            <i class="fas fa-plus"></i> Add Expenses
        </a>
    </div>
    {% endif %}
</div>

<!-- AI Insights -->
<div class="modern-card fade-in" style="margin: 24px 32px 0;">
    <div class="card-header-modern">
        <h3 class="card-title-modern">
            <i class="fas fa-brain"></i> AI Insights
        </h3>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <div style="padding: 20px; background: linear-gradient(135deg, rgba(75, 63, 255, 0.1), rgba(107, 95, 255, 0.05)); border-radius: var(--radius-md); border-left: 4px solid var(--primary-color);">
            <h4 style="margin: 0 0 8px; color: var(--primary-color); font-size: 16px;">
                <i class="fas fa-lightbulb"></i> Spending Pattern
            </h4>
            <p style="margin: 0; color: var(--text-dark); font-size: 14px; line-height: 1.5;">
                Your spending typically increases by 15% during weekends. Consider setting weekend budgets to maintain control.
            </p>
        </div>
        
        <div style="padding: 20px; background: linear-gradient(135deg, rgba(255, 184, 77, 0.1), rgba(255, 159, 26, 0.05)); border-radius: var(--radius-md); border-left: 4px solid var(--accent-color);">
            <h4 style="margin: 0 0 8px; color: var(--accent-color); font-size: 16px;">
                <i class="fas fa-chart-line"></i> Trend Alert
            </h4>
            <p style="margin: 0; color: var(--text-dark); font-size: 14px; line-height: 1.5;">
                Food expenses have increased 23% this month. Consider meal planning to optimize your food budget.
            </p>
        </div>
        
        <div style="padding: 20px; background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05)); border-radius: var(--radius-md); border-left: 4px solid var(--success-color);">
            <h4 style="margin: 0 0 8px; color: var(--success-color); font-size: 16px;">
                <i class="fas fa-thumbs-up"></i> Good News
            </h4>
            <p style="margin: 0; color: var(--text-dark); font-size: 14px; line-height: 1.5;">
                You're on track to save 12% more than last month. Keep up the great work with your spending habits!
            </p>
        </div>
    </div>
</div>

<style>
@media (max-width: 768px) {
    div[style*="grid-template-columns: 2fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
}
</style>

{% endblock content %}

{% block js %}
// Forecast Chart
const forecastCtx = document.getElementById('forecastChart').getContext('2d');
const categoryForecastCtx = document.getElementById('categoryForecastChart').getContext('2d');

// Main Forecast Line Chart
const forecastChart = new Chart(forecastCtx, {
    type: 'line',
    data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        datasets: [{
            label: 'Actual Expenses',
            data: [1200, 1900, 800, 1500, 2000, 1800],
            borderColor: '#4B3FFF',
            backgroundColor: 'rgba(75, 63, 255, 0.1)',
            borderWidth: 3,
            fill: false,
            tension: 0.4,
            pointBackgroundColor: '#4B3FFF',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6
        }, {
            label: 'Forecasted Expenses',
            data: [null, null, null, null, null, 1800, 1950, 2100, 1850, 2200, 2050, 2300],
            borderColor: '#FFB84D',
            backgroundColor: 'rgba(255, 184, 77, 0.1)',
            borderWidth: 3,
            borderDash: [5, 5],
            fill: false,
            tension: 0.4,
            pointBackgroundColor: '#FFB84D',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    usePointStyle: true,
                    padding: 20
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                },
                ticks: {
                    callback: function(value) {
                        return '{{currency}}' + value;
                    }
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// Category Forecast Doughnut Chart
const categoryForecastChart = new Chart(categoryForecastCtx, {
    type: 'doughnut',
    data: {
        labels: ['Food', 'Transport', 'Entertainment', 'Utilities', 'Shopping'],
        datasets: [{
            data: [35, 20, 15, 20, 10],
            backgroundColor: [
                '#4B3FFF',
                '#FFB84D',
                '#28a745',
                '#dc3545',
                '#6f42c1'
            ],
            borderWidth: 0,
            hoverBorderWidth: 2,
            hoverBorderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 15,
                    usePointStyle: true,
                    font: {
                        size: 11
                    }
                }
            }
        },
        cutout: '60%'
    }
});

function updateForecast(period) {
    // Update chart based on period
    console.log('Updating forecast for period:', period);
    // Add your forecast update logic here
}

function refreshForecast() {
    // Refresh forecast data
    console.log('Refreshing forecast...');
    // Add your refresh logic here
}
{% endblock js %}